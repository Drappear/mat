<!DOCTYPE html>
<html lang="en" layout:decorate="~{/layouts/layout}">
<th:block layout:fragment="css">
  <!-- modal css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" th:href="@{/css/recipe_create.css}" />
</th:block>

<div layout:fragment="content">
  <div class="container mt-5">
    <div id="webcrumbs">
      <div class="w-[1200px] bg-white shadow-lg rounded-lg p-8">
        <div class="flex justify-between items-center mb-6 bg-neutral-100 p-4 rounded-md">
          <h2 class="text-lg font-title">ë ˆì‹œí”¼ ë“±ë¡</h2>
          <!-- ëª¨ë‹¬ì„ ì‹¤í–‰í•  ë²„íŠ¼ -->
          <!-- Modal Button -->
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            ë ˆì‹œí”¼ ë“±ë¡ ì˜ˆì‹œ
          </button>

          <!-- Modal -->
          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">Modal
                    title</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <img src="https://placehold.co/300x900/png" class="card-img-top" alt="..." />
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary">Save
                    changes</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <form th:action="@{create}" method="post" id="createForm" th:object="${recipeDto}">
          <!-- ë ˆì‹œí”¼ ì œëª© ë° ìš”ì•½ -->
          <div class="form-section">
            <div class="space-y-4">
              <div class="p-4 bg-neutral-50 rounded-lg">
                <div class="grid grid-cols-3 gap-4 items-center">
                  <label for="recipeTitle" class="text-neutral-950 form-label">ë ˆì‹œí”¼ ì œëª©</label>
                  <input type="text" id="recipeTitle" placeholder="ì˜ˆ) ì†Œê³ ê¸° ë§Œë‘êµ­ ë“ì´ê¸°" th:value="${recipeDto.title}"
                    class="col-span-2 border-neutral-300 border rounded-md px-3 py-2 form-control" />
                  <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="text-danger"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <label for="recipeDescription" class="text-neutral-950 form-label">ìš”ë¦¬ ì†Œê°œ</label>
                <textarea id="recipeDescription" placeholder="ìš”ë¦¬ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”."
                  class="form-control col-span-2 border-neutral-300 border rounded-md px-3 py-2" rows="4"></textarea>
              </div>
            </div>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <label for="category" class="form-label text-neutral-950">ì¹´í…Œê³ ë¦¬</label>
                <select id="category" name="category"
                  class="form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2">
                  <option value>ì„ íƒ</option>
                  <option th:each="category : ${categories}" th:value="${category.rCateId}" th:text="${category.name}">
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- ìš”ë¦¬ì •ë³´ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <!--flex gap-5 items-center -->
                <label for="cookingInfo" class="form-label text-neutral-950">ìš”ë¦¬ ì •ë³´</label>
                <div class="col-span-2 flex justify-end gap-4">
                  <div>
                    <!-- <label for="servings" class="form-label text-neutral-950">ì¸ì›</label> -->
                    <select id="serving" name="serving"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ì¸ì› ì„ íƒ</option>
                      <option value="1">1ì¸ë¶„</option>
                      <option value="2">2ì¸ë¶„</option>
                      <option value="3">3ì¸ë¶„</option>
                      <option value="4">4ì¸ë¶„</option>
                      <option value="5">5ì¸ë¶„</option>
                    </select>
                  </div>
                  <div>
                    <select id="time" name="time"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ì‹œê°„ ì„ íƒ</option>
                      <option value="10">10ë¶„ ì´ë‚´</option>
                      <option value="30">30ë¶„ ì´ë‚´</option>
                      <option value="60">60ë¶„ ì´ë‚´</option>
                      <option value="90">90ë¶„ ì´ë‚´</option>
                      <option value="120">2ì‹œê°„ ì´ë‚´</option>
                      <option value="180">2ì‹œê°„ ì´ìƒ</option>
                    </select>
                  </div>
                  <div>
                    <select id="difficulty" name="difficulty"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ë‚œì´ë„ ì„ íƒ</option>
                      <option value="1">ì‰¬ì›€</option>
                      <option value="2">ë³´í†µ</option>
                      <option value="3">ì–´ë ¤ì›€</option>
                      <option value="4">ë§¤ìš°ì–´ë ¤ì›€</option>
                      <option value="5">ì‹ ì˜ê²½ì§€</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- ì¬ë£Œ ì •ë³´ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <h3 class="text-neutral-950 font-title mb-2">ì¬ë£Œ ì •ë³´</h3>
              <div id="ingredientsWrapper">
                <div id="ingredientsContainer">
                  <div class="space-y-2">
                    <div class="ingredient-input">
                      <div class="grid grid-cols-4 gap-4 items-center">
                        <input id="ingreName1" name="ingreName1" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2" placeholder="ì¬ë£Œëª…" />
                        <input id="ingreAmount1" name="ingreAmount1" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2"
                          placeholder="ìš©ëŸ‰ (ì˜ˆ: 10g)" />
                      </div>
                    </div>
                    <div class="ingredient-input mb-2">
                      <div class="grid grid-cols-4 gap-4 items-center">
                        <input id="ingreName2" name="ingreName2" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2" placeholder="ì¬ë£Œëª…" />
                        <input id="ingreAmount2" name="ingreAmount2" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2"
                          placeholder="ìš©ëŸ‰ (ì˜ˆ: 10g)" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ì¬ë£Œ ì •ë³´ ì¶”ê°€ ë²„íŠ¼ -->
              <div class="flex justify-center">
                <button type="button" id="addIngredientBtn" name="addIngredientBtn"
                  class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                  <span class="material-symbols-outlined">add</span>
                  ì¬ë£Œ ì¶”ê°€
                </button>
              </div>
              <p class="text-sm text-neutral-500 mt-4 text-center">
                ìµœì†Œ ì¬ë£Œ 2ê°œëŠ” ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ í–‰ì´
                ì¶”ê°€ë©ë‹ˆë‹¤. (ìµœëŒ€ 50ì¤„)
              </p>
            </div>
          </div>

          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- step ì¶”ê°€  -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <h3 class="text-neutral-950 font-title mb-2">ìš”ë¦¬ ìˆœì„œ</h3>
              <p class="text-sm text-neutral-500 mt-4">
                ğŸ’¡ ìš”ë¦¬ì˜ ë§›ì´ ì¢Œìš°ë  ìˆ˜ ìˆëŠ” ì¤‘ìš”í•œ ë¶€ë¶„ì€ ë¹ ì§ì—†ì´
                ì ì–´ì£¼ì„¸ìš”.
                <br /><br />
                ì˜ˆ) 10ë¶„ê°„ ìµí˜€ì£¼ì„¸ìš” â–¶ 10ë¶„ê°„ ì•½í•œë¶ˆë¡œ ìµí˜€ì£¼ì„¸ìš”.<br />
                ë§ˆëŠ˜í¸ì€ ìµí˜€ì£¼ì„¸ìš” â–¶ ë§ˆëŠ˜í¸ì„ ì¶©ë¶„íˆ ìµí˜€ì£¼ì…”ì•¼ ë§¤ìš´ ë§›ì´
                ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br />
                ê¿€ì„ ì¡°ê¸ˆ ë„£ì–´ì£¼ì„¸ìš” â–¶ ê¿€ì´ ì—†ëŠ” ê²½ìš°, ì„¤íƒ• 1ìŠ¤í‘¼ìœ¼ë¡œ ëŒ€ì²´
                ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </p>
              <div class="rounded-md p-4 stepContainer" id="stepContainer">
                <div class="flex items-center gap-4 mb-6">
                  <div class="text-lime-500 font-semibold text-lg">Step1</div>
                  <textarea id="stepText1" name="stepText1"
                    class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none"
                    placeholder="{`step1`}"></textarea>
                  <div id="stepImg1" name="stepImg1"
                    class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                  </div>
                </div>
                <div class="flex items-center gap-4 mb-6">
                  <div class="text-lime-500 font-semibold text-lg">Step2</div>
                  <textarea id="stepText2" name="stepText2"
                    class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none"
                    placeholder="{`step2`}"></textarea>
                  <div id="stepImg2" name="stepImg2"
                    class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                  </div>
                </div>
                <div class="flex items-center gap-4 mb-6">
                  <div class="text-lime-500 font-semibold text-lg">Step3</div>
                  <textarea id="stepText3" name="stepText3"
                    class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none"
                    placeholder="{`step3`}"></textarea>
                  <!-- ì´ë¯¸ì§€ ì¶”ê°€ ì˜ì—­ -->
                  <div id="stepImg3" name="stepImg3"
                    class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                  </div>
                </div>
                <!-- step ì¶”ê°€ button -->
                <div class="flex justify-center">
                  <button id="addStepButton" name="addStepButton"
                    class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                    <span class="material-symbols-outlined">add</span>
                    Step ì¶”ê°€
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ -->
          <div class="form-section">
            <div class="flex items-center gap-4 mb-6 mt-6">
              <h3 class="text-neutral-950 font-title mb-2">ìš”ë¦¬ ì™„ì„± ì‚¬ì§„</h3>
              <div class="finalImgContainer flex items-center gap-2">
                <div id="recipeFinalImg1" name="recipeFinalImg1" class="relative">
                  <div
                    class="recipeFinalImg1 w-[140px] h-[140px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                  </div>
                  <!-- <button
                      class="absolute top-0 right-0 bg-black text-white w-[24px] h-[24px] flex items-center justify-center rounded-full text-xs">
                      âœ•
                    </button> -->
                </div>

              </div>
              <!-- ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ ì¶”ê°€ button -->
              <div class="flex justify-center">
                <button id="addFinalImgButton" name="addFinalImgButton"
                  class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                  <span class="material-symbols-outlined">add</span>
                  ì‚¬ì§„ ì¶”ê°€
                </button>
              </div>
            </div>
            <p class="text-sm text-neutral-500 mt-4 mb-4 flex items-center justify-center">
              ìµœì†Œ ì‚¬ì§„ 1ì¥ì€ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì²«ë²ˆì§¸ë¡œ ë“±ë¡í•œ ì‚¬ì§„ì´ ëŒ€í‘œì‚¬ì§„ì´ ë©ë‹ˆë‹¤. (ìµœëŒ€ ë“±ë¡ ì‚¬ì§„ 4ì¥)
            </p>
            <p class="text-sm text-neutral-500 mt-4 mb-4 flex items-center justify-center">
              ì²«ë²ˆì§¸ë¡œ ë“±ë¡í•œ ì‚¬ì§„ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹ , ë‹¤ì‹œ ì˜ì—­ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ êµì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
            <!-- button -->
            <div class="flex justify-center items-center gap-4">
              <button type="submit" class="bg-lime-500 text-white rounded-md py-2 px-6 text-sm">
                ì €ì¥ í›„ ê³µê°œí•˜ê¸°
              </button>
              <a 
              th:href="@{list(page=${requestDto.page},size=${requestDto.size},type=${requestDto.type},keyword=${requestDto.keyword})}"
              class="border border-lime-500 text-lime-500 rounded-md py-2 px-6 text-sm">
                ì·¨ì†Œ
              </a>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<th:block layout:fragment="js">
  <script>
    const csrfValue = '[[${_csrf.token}]]';
  </script>

  <!-- TODO: ì¬ë£Œì •ë³´ row ì¶”ê°€ ë²„íŠ¼ -->
  <script>
    document.getElementById("addIngredientBtn").addEventListener("click", () => {
        try {
            // ì¬ë£Œ ì»¨í…Œì´ë„ˆ
            const ingredientsContainer = document.getElementById("ingredientsContainer");

            // í˜„ì¬ ì¶”ê°€ëœ ì¬ë£Œ ì •ë³´ë“¤ì˜ ìˆ˜ í™•ì¸
            const currentInputs = ingredientsContainer.getElementsByClassName("ingredient-input");
            const newIndex = currentInputs.length + 1;

            // ìµœëŒ€ 50ê°œì˜ ì¬ë£Œë§Œ í—ˆìš©
            if (newIndex > 50) {
                alert("ìµœëŒ€ 50ê°œì˜ ì¬ë£Œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            // ìƒˆë¡œìš´ ì¬ë£Œ ì…ë ¥ í•„ë“œ ìƒì„±
            const newIngredientDiv = document.createElement("div");
            newIngredientDiv.className = "ingredient-input";
            newIngredientDiv.innerHTML = `
                <div class="grid grid-cols-4 gap-4 items-center">
                    <input id="ingreName${newIndex}" name="ingreName${newIndex}" type="text"
                        class="form-control border-neutral-300 border rounded-md px-3 py-2"
                        placeholder="ì¬ë£Œëª…" />
                    <input id="ingreAmount${newIndex}" name="ingreAmount${newIndex}" type="text"
                        class="form-control border-neutral-300 border rounded-md px-3 py-2"
                        placeholder="ìš©ëŸ‰ (ì˜ˆ: 10g)" />
                    <button type="button" class="btn btn-danger delete-row-btn bg-red-500 text-white px-3 py-2 rounded-md">X</button>
                </div>
            `;

            // ìƒˆë¡œìš´ ì…ë ¥ í•„ë“œë¥¼ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
            ingredientsContainer.appendChild(newIngredientDiv);

            // ì…ë ¥ í•„ë“œê°€ 10ê°œë¥¼ ì´ˆê³¼í•  ê²½ìš° ìŠ¤í¬ë¡¤ë°” í™œì„±í™”
            if (currentInputs.length >= 10) {
                ingredientsContainer.style.maxHeight = "400px"; // ìµœëŒ€ ë†’ì´ ì„¤ì •
                ingredientsContainer.style.overflowY = "auto"; // ìˆ˜ì§ ìŠ¤í¬ë¡¤ í™œì„±í™”
            }

            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
            const deleteButton = newIngredientDiv.querySelector(".delete-row-btn");
            deleteButton.addEventListener("click", () => handleDeleteRow(newIngredientDiv));
        } catch (error) {
            console.error("ì¬ë£Œ ì •ë³´ ì…ë ¥ì¤„ì„ ì¶”ê°€í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", error);
            alert("ì¬ë£Œ ì •ë³´ ì…ë ¥ì¤„ì„ ì¶”ê°€í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
    });

    function handleDeleteRow(rowElement) {
        const inputs = rowElement.querySelectorAll("input");
        const hasInputValue = Array.from(inputs).some(input => input.value.trim() !== "");

        if (hasInputValue) {
            const confirmDelete = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì •ì¤‘ì— ì‚­ì œí•œ ì¤„ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirmDelete) return;
        }

        // ì‚­ì œëœ í–‰ ì œê±°
        rowElement.remove();

        // ì¬ë£Œ ì •ë³´ ì¬ì •ë ¬
        reorderIngredients();
    }

    function reorderIngredients() {
        const ingredientsContainer = document.getElementById("ingredientsContainer");
        const rows = ingredientsContainer.querySelectorAll(".ingredient-input");

        rows.forEach((rowElement, index) => {
            const newIndex = index + 1;

            // ì¬ë£Œëª… Input ID ë° Name ë³€ê²½
            const ingreNameInput = rowElement.querySelector('input[id^="ingreName"]');
            ingreNameInput.id = `ingreName${newIndex}`;
            ingreNameInput.name = `ingreName${newIndex}`;

            // ìš©ëŸ‰ Input ID ë° Name ë³€ê²½
            const ingreAmountInput = rowElement.querySelector('input[id^="ingreAmount"]');
            ingreAmountInput.id = `ingreAmount${newIndex}`;
            ingreAmountInput.name = `ingreAmount${newIndex}`;
        });
    }

    // ê¸°ì¡´ ì…ë ¥ í•„ë“œì— ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ (ì¬ë£Œ ì •ë³´ 2ì¤„ ì œì™¸)
    document.querySelectorAll("#ingredientsContainer .ingredient-input").forEach((rowElement, index) => {
        if (index >= 2) {
            const deleteButton = document.createElement("button");
            deleteButton.type = "button";
            deleteButton.className = "delete-row-btn bg-red-500 text-white px-3 py-2 rounded-md";
            deleteButton.textContent = "X";
            deleteButton.addEventListener("click", () => handleDeleteRow(rowElement));
            rowElement.querySelector(".grid").appendChild(deleteButton);
        }
    });
  </script>

  <!-- TODO: step row ì¶”ê°€ ë²„íŠ¼ / step ì´ë¯¸ì§€ ì¶”ê°€ -->
  <script>
    // Step ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('addStepButton').addEventListener('click', function (event) {
      try {
        // ê¸°ë³¸ ë™ì‘(submit) ë°©ì§€
        event.preventDefault();

        // Step ì»¨í…Œì´ë„ˆë¥¼ ê°€ì ¸ì˜¤ê¸°
        const stepContainer = document.querySelector('.stepContainer');

        // í˜„ì¬ Step ê°¯ìˆ˜ë¥¼ ê³„ì‚°
        const stepCount = stepContainer.querySelectorAll('.flex.items-center.gap-4.mb-6').length;
        const nextStepNumber = stepCount + 1;

        if (nextStepNumber > 25) {
          throw new Error('ìµœëŒ€ 25ê°œì˜ Stepë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }

        // ìƒˆ Step ìš”ì†Œ ìƒì„±
        const newStep = document.createElement('div');
        newStep.className = 'flex items-center gap-4 mb-6';
        newStep.innerHTML = `
                <div class="text-lime-500 font-semibold text-lg">Step${nextStepNumber}</div>
                <textarea
                    id="stepText${nextStepNumber}"
                    name="stepText${nextStepNumber}"
                    class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none"
                    placeholder="{\`step${nextStepNumber}\`}"></textarea>
                <div
                    id="stepImg${nextStepNumber}"
                    name="stepImg${nextStepNumber}"
                    class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                </div>
                <button type="button" class="btn btn-danger delete-step-btn bg-red-500 text-white px-3 py-2 rounded-md">X</button>
            `;

        // ìƒˆ Step ìš”ì†Œë¥¼ stepContainerì˜ ë§¨ ë’¤ì— ì¶”ê°€
        stepContainer.appendChild(newStep);

        // ìŠ¤í¬ë¡¤ë°” ë™ì‘ ì²˜ë¦¬ (5ê°œ ì´ìƒì˜ Stepì¼ ê²½ìš°)
        if (stepCount >= 4) {
          stepContainer.style.maxHeight = '800px';
          stepContainer.style.overflowY = 'auto';
        }

        // step ì¶”ê°€ ë²„íŠ¼ì„ ìƒˆë¡œ ì¶”ê°€ëœ Step ì•„ë˜ë¡œ ì´ë™
        const addButton = document.getElementById('addStepButton');
        stepContainer.appendChild(addButton);

        // ìƒˆë¡œ ì¶”ê°€ëœ Stepì—ë„ ì´ë²¤íŠ¸ ì¶”ê°€
        bindImageUploadEvent();
        bindDeleteStepEvent(newStep);

      } catch (error) {
        // ì˜ˆì™¸ ì²˜ë¦¬
        alert(error.message || 'Step ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒ.');
        console.error(error);
      }
    });

    // stepImg í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
function bindImageUploadEvent() {
    // ê° stepImg ìš”ì†Œì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('[id^="stepImg"]').forEach(stepImg => {
        // ì¤‘ë³µ ì´ë²¤íŠ¸ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±°
        stepImg.replaceWith(stepImg.cloneNode(true)); // ê¸°ì¡´ ë…¸ë“œë¥¼ ë³µì œí•˜ì—¬ ëª¨ë“  ì´ë²¤íŠ¸ ì œê±°
        const clonedStepImg = document.querySelector(`#${stepImg.id}`);

        // ìƒˆë¡œìš´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        clonedStepImg.addEventListener('click', function () {
            // íŒŒì¼ ì„ íƒì„ ìœ„í•œ input ìš”ì†Œ ìƒì„±
            const inputFile = document.createElement('input');
            inputFile.type = 'file';
            inputFile.accept = 'image/*'; // ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì„ íƒ ê°€ëŠ¥

            // íŒŒì¼ ì„ íƒ í›„ ì´ë¯¸ì§€ í‘œì‹œí•˜ê¸°
            inputFile.addEventListener('change', function (event) {
                const file = event.target.files[0]; // ì²« ë²ˆì§¸ íŒŒì¼ ì„ íƒ

                if (file) {
                    // ì„ íƒí•œ íŒŒì¼ì„ ì´ë¯¸ì§€ë¡œ í‘œì‹œ
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        // ì´ë¯¸ì§€ë¥¼ ë¯¸ë¦¬ë³´ê¸°ë¡œ ì¶”ê°€
                        const imgElement = document.createElement('img');
                        imgElement.src = e.target.result;
                        imgElement.alt = 'Uploaded Image';
                        imgElement.className = 'w-[160px] h-[160px] object-cover rounded-md';

                        // stepImg ì˜ì—­ì— ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ê³ , 'add' ì•„ì´ì½˜ì„ ìˆ¨ê¹€
                        clonedStepImg.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì§€ìš°ê¸°
                        clonedStepImg.appendChild(imgElement);
                    };
                    reader.readAsDataURL(file); // íŒŒì¼ì„ data URLë¡œ ì½ì–´ ë¯¸ë¦¬ë³´ê¸° ìƒì„±
                }
            });

            // íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
            inputFile.click();
        });
    });
}

    // Step ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© í•¨ìˆ˜
    function bindDeleteStepEvent(stepElement) {
      const deleteButton = stepElement.querySelector('.delete-step-btn');
      deleteButton.addEventListener('click', function () {
        const textArea = stepElement.querySelector('textarea');
        const hasInputValue = textArea && textArea.value.trim() !== '';

        if (hasInputValue) {
          const confirmDelete = confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì •ì¤‘ì— ì‚­ì œí•œ ì¤„ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          if (!confirmDelete) return;
        }

        // Step ì‚­ì œ
        stepElement.remove();

        // Step ì¬ì •ë ¬
        reorderSteps();
      });
    }

    // Step ì¬ì •ë ¬ í•¨ìˆ˜
    function reorderSteps() {
      const stepContainer = document.querySelector('.stepContainer');
      const stepElements = stepContainer.querySelectorAll('.flex.items-center.gap-4.mb-6');

      stepElements.forEach((stepElement, index) => {
        const newStepNumber = index + 1;

        // Step ë²ˆí˜¸ ë³€ê²½
        stepElement.querySelector('.text-lime-500').textContent = `Step${newStepNumber}`;

        // Textarea ID ë° Name ë³€ê²½
        const textArea = stepElement.querySelector('textarea');
        textArea.id = `stepText${newStepNumber}`;
        textArea.name = `stepText${newStepNumber}`;

        // Image ID ë° Name ë³€ê²½
        const stepImg = stepElement.querySelector('[id^="stepImg"]');
        stepImg.id = `stepImg${newStepNumber}`;
        stepImg.name = `stepImg${newStepNumber}`;
      });
    }

    // í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ì¡´ Stepë“¤ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.addEventListener('DOMContentLoaded', function () {
      bindImageUploadEvent();

      document.querySelectorAll('.flex.items-center.gap-4.mb-6').forEach(stepElement => {
        bindDeleteStepEvent(stepElement);
      });
    });
  </script>

  <!-- TODO: ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ ê´€ë ¨ë ¨ í™”ë©´ë‹¨ ë™ì‘ -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const maxImages = 4; // ìµœëŒ€ ì‚¬ì§„ ì¶”ê°€ ê°€ëŠ¥ ê°œìˆ˜
      const addButton = document.getElementById("addFinalImgButton");
      const container = document.querySelector(".finalImgContainer"); // ì‚¬ì§„ ì˜ì—­ì„ ì¶”ê°€í•  ë¶€ëª¨ ì»¨í…Œì´ë„ˆ

      // ì´ˆê¸° ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸ í™œì„±í™”
      const initialImageDiv = document.querySelector("#recipeFinalImg1 > .recipeFinalImg1");
      if (initialImageDiv) {
        initialImageDiv.addEventListener("click", () => handleImageUpload(initialImageDiv));
      }

      // ì‚¬ì§„ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
      addButton.addEventListener("click", (event) => {
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘(í¼ ì œì¶œ) ë°©ì§€

        try {
          const currentImages = container.querySelectorAll(".relative").length;

          if (currentImages >= maxImages) {
            alert("ì‚¬ì§„ì€ ìµœëŒ€ 4ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          const newImageId = `recipeFinalImg${currentImages + 1}`;
          const newDiv = document.createElement("div");
          newDiv.classList.add("relative");
          newDiv.innerHTML = `
                      <div
                          id="${newImageId}"
                          name="${newImageId}"
                          class="w-[140px] h-[140px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                          <span class="material-symbols-outlined text-neutral-400">add</span>
                      </div>
                      <button
                          type="button"
                          class="absolute top-0 right-0 bg-black text-white w-[24px] h-[24px] flex items-center justify-center rounded-full text-xs">
                          âœ•
                      </button>
                  `;

          container.appendChild(newDiv);

          // í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì´ë¯¸ì§€ ì—…ë¡œë“œ
          const imageDiv = newDiv.querySelector(`#${newImageId}`);
          imageDiv.addEventListener("click", () => handleImageUpload(imageDiv));

          // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
          const deleteButton = newDiv.querySelector("button");
          deleteButton.addEventListener("click", () => handleDeleteImage(newDiv));
        } catch (error) {
          console.error("ì‚¬ì§„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      });

      // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
      function handleImageUpload(imageDiv) {
        try {
          // íŒŒì¼ ì„ íƒ input ìƒì„± ë° íŠ¸ë¦¬ê±°
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/*";
          fileInput.style.display = "none";
          document.body.appendChild(fileInput);

          fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                imageDiv.style.backgroundImage = `url(${e.target.result})`;
                imageDiv.style.backgroundSize = "cover";
                imageDiv.style.backgroundPosition = "center";
                imageDiv.textContent = ""; // 'add' í…ìŠ¤íŠ¸ ì œê±°
              };
              reader.readAsDataURL(file);
            }
            document.body.removeChild(fileInput); // íŒŒì¼ ì…ë ¥ ìš”ì†Œ ì œê±°
          });

          fileInput.click();
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }

      // ì´ë¯¸ì§€ ì‚­ì œ ì²˜ë¦¬
      function handleDeleteImage(imageDiv) {
        try {
          container.removeChild(imageDiv);
          updateImageIds();
        } catch (error) {
          console.error("ì‚¬ì§„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }

      // ì´ë¯¸ì§€ IDì™€ Name ì¬ì •ë ¬
      function updateImageIds() {
        try {
          const images = container.querySelectorAll(".relative");
          images.forEach((image, index) => {
            const newId = `recipeFinalImg${index + 1}`;
            const imageDiv = image.querySelector("div");
            imageDiv.id = newId;
            imageDiv.name = newId;
          });
        } catch (error) {
          console.error("ì´ë¯¸ì§€ ID ì¬ì •ë ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }
    });      
  </script>

  <!-- TODO:::::upload.js -->
  <script>
    // x ë¥¼ ëˆ„ë¥´ë©´ ì‚­ì œ ìš”ì²­ => ë¶€ëª¨ ì´ë²¤íŠ¸
    document.querySelector(".uploadResult").addEventListener("click", (e) => {
      // a íƒœê·¸ ê¸°ëŠ¥ ì¤‘ì§€
      e.preventDefault();

      // href ê°’ ê°€ì ¸ì˜¤ê¸°
      const element = e.target.closest("a");

      // ì´ë¯¸ì§€ ì‚­ì œ
      const removeLi = e.target.closest("li");

      // ì‚­ì œ í•  ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ì¶œ
      const filePath = element.getAttribute("href");

      let formData = new FormData();
      formData.append("filePath", filePath);

      fetch("/upload/remove", {
        method: "post",
        headers: {
          "X-CSRF-TOKEN": csrfValue,
        },
        body: formData,
      })
        .then((response) => {
          if (!response.ok) throw new Error("ì—ëŸ¬ ë°œìƒ");

          return response.text();
        })
        .then((data) => {
          // í™”ë©´ ì´ë¯¸ì§€ ì œê±°
          if (data) removeLi.remove();
        });
    });
  </script>

  <!-- <script th:src="@{/js/upload.js}"></script> -->
  <!-- <script th:src="@{/js/create.js}"></script> -->

</th:block>

</html>