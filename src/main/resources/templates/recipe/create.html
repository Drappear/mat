<!DOCTYPE html>
<html lang="en" layout:decorate="~{/layouts/layout}">
<th:block layout:fragment="css">
  <!-- modal css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="stylesheet" th:href="@{/css/recipe_create.css}" />
</th:block>

<div layout:fragment="content">
  <div class="container mt-5">
    <div id="webcrumbs">
      <div class="w-[1200px] bg-white shadow-lg rounded-lg p-8">
        <div class="flex justify-between items-center mb-6 bg-neutral-100 p-4 rounded-md">
          <h2 class="text-lg font-title">ë ˆì‹œí”¼ ë“±ë¡</h2>
          <!-- ëª¨ë‹¬ì„ ì‹¤í–‰í•  ë²„íŠ¼ -->
          <!-- Modal Button -->
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            ë ˆì‹œí”¼ ë“±ë¡ ì˜ˆì‹œ
          </button>

          <!-- Modal -->
          <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5" id="exampleModalLabel">ë ˆì‹œí”¼ ë“±ë¡ ì˜ˆì‹œ</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <img src="/assets/img/recipeModal/MergedImages.png" class="card-img-top" alt="..." />
                  <!-- <img src="https://placehold.co/300x900/png"
                      class="card-img-top" alt="..." /> -->
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <!-- <button type="button" class="btn btn-primary">Save
                      changes</button> -->
                </div>
              </div>
            </div>
          </div>
        </div>

        <form th:action="@{/recipe/create}" method="post" id="createForm" th:object="${recipeDto}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
          <!-- ë ˆì‹œí”¼ ì œëª© ë° ìš”ì•½ -->
          <div class="form-section">
            <div class="space-y-4">
              <div class="p-4 bg-neutral-50 rounded-lg">
                <div class="grid grid-cols-3 gap-4 items-center">
                  <label for="title" class="text-neutral-950 form-label">ë ˆì‹œí”¼
                    ì œëª©</label>
                  <input type="text" id="title" name="title" placeholder="ì˜ˆ) ì†Œê³ ê¸° ë§Œë‘êµ­ ë“ì´ê¸°" th:value="${recipeDto.title}"
                    class="col-span-2 border-neutral-300 border rounded-md px-3 py-2 form-control" />
                  <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="text-danger"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <label for="content" class="text-neutral-950 form-label">ìš”ë¦¬
                  ì†Œê°œ</label>
                <textarea id="content" name="content" th:text="${recipeDto.content}" placeholder="ìš”ë¦¬ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”."
                  class="form-control col-span-2 border-neutral-300 border rounded-md px-3 py-2" rows="4"></textarea>
              </div>
            </div>
          </div>

          <!-- ì¹´í…Œê³ ë¦¬ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <label for="category" class="form-label text-neutral-950">ì¹´í…Œê³ ë¦¬</label>
                <select id="category" name="category"
                  class="form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2">
                  <option value>ì„ íƒ</option>
                  <option th:each="category : ${categories}" th:value="${category.rCateId}" th:text="${category.name}">
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- ìš”ë¦¬ì •ë³´ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <div class="grid grid-cols-3 gap-4 items-center">
                <!--flex gap-5 items-center -->
                <label for="cookingInfo" class="form-label text-neutral-950">ìš”ë¦¬ ì •ë³´</label>
                <div class="col-span-2 flex justify-end gap-4">
                  <div>
                    <!-- <label for="servings" class="form-label text-neutral-950">ì¸ì›</label> -->
                    <select id="serving" name="serving"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ì¸ì› ì„ íƒ</option>
                      <option value="1">1ì¸ë¶„</option>
                      <option value="2">2ì¸ë¶„</option>
                      <option value="3">3ì¸ë¶„</option>
                      <option value="4">4ì¸ë¶„</option>
                      <option value="5">5ì¸ë¶„</option>
                    </select>
                  </div>
                  <div>
                    <select id="time" name="time"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ì‹œê°„ ì„ íƒ</option>
                      <option value="10">10ë¶„ ì´ë‚´</option>
                      <option value="30">30ë¶„ ì´ë‚´</option>
                      <option value="60">60ë¶„ ì´ë‚´</option>
                      <option value="90">90ë¶„ ì´ë‚´</option>
                      <option value="120">2ì‹œê°„ ì´ë‚´</option>
                      <option value="180">2ì‹œê°„ ì´ìƒ</option>
                    </select>
                  </div>
                  <div>
                    <select id="difficulty" name="difficulty"
                      class="select-info form-select-sm col-span-2 border-neutral-300 border rounded-md px-3 py-2 w-[180px]">
                      <option value>ë‚œì´ë„ ì„ íƒ</option>
                      <option value="1">ì‰¬ì›€</option>
                      <option value="2">ë³´í†µ</option>
                      <option value="3">ì–´ë ¤ì›€</option>
                      <option value="4">ë§¤ìš°ì–´ë ¤ì›€</option>
                      <option value="5">ì‹ ì˜ê²½ì§€</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- ì¬ë£Œ ì •ë³´ -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <h3 class="text-neutral-950 font-title mb-2">ì¬ë£Œ ì •ë³´</h3>
              <div id="ingredientsWrapper">
                <div id="ingredientsContainer">
                  <div class="space-y-2">
                    <div class="ingredient-input">
                      <div class="grid grid-cols-4 gap-4 items-center">
                        <input id="recipeIngredientDtos[0].name" name="recipeIngredientDtos[0].name" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2" placeholder="ì¬ë£Œëª…" />
                        <input id="recipeIngredientDtos[0].quantity" name="recipeIngredientDtos[0].quantity" type="text"
                          class="form-control border-neutral-300 border rounded-md px-3 py-2"
                          placeholder="ìš©ëŸ‰ (ì˜ˆ: 10g)" />
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ì¬ë£Œ ì •ë³´ ì¶”ê°€ ë²„íŠ¼ -->
              <div class="flex justify-center">
                <button type="button" id="addIngredientBtn" name="addIngredientBtn"
                  class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                  <span class="material-symbols-outlined">add</span>
                  ì¬ë£Œ ì¶”ê°€
                </button>
              </div>
              <p class="text-sm text-neutral-500 mt-4 text-center">
                ìµœì†Œ ì¬ë£Œ 2ê°œëŠ” ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ìƒˆë¡œìš´ í–‰ì´
                ì¶”ê°€ë©ë‹ˆë‹¤. (ìµœëŒ€ 50ì¤„)
              </p>
            </div>
          </div>

          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- step ì¶”ê°€  -->
          <div class="form-section">
            <div class="p-4 bg-neutral-50 rounded-lg">
              <h3 class="text-neutral-950 font-title mb-2">ìš”ë¦¬ ìˆœì„œ</h3>
              <p class="text-sm text-neutral-500 mt-4">
                ğŸ’¡ ìš”ë¦¬ì˜ ë§›ì´ ì¢Œìš°ë  ìˆ˜ ìˆëŠ” ì¤‘ìš”í•œ ë¶€ë¶„ì€ ë¹ ì§ì—†ì´
                ì ì–´ì£¼ì„¸ìš”.
                <br /><br />
                ì˜ˆ) 10ë¶„ê°„ ìµí˜€ì£¼ì„¸ìš” â–¶ 10ë¶„ê°„ ì•½í•œë¶ˆë¡œ ìµí˜€ì£¼ì„¸ìš”.<br />
                ë§ˆëŠ˜í¸ì€ ìµí˜€ì£¼ì„¸ìš” â–¶ ë§ˆëŠ˜í¸ì„ ì¶©ë¶„íˆ ìµí˜€ì£¼ì…”ì•¼ ë§¤ìš´ ë§›ì´
                ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br />
                ê¿€ì„ ì¡°ê¸ˆ ë„£ì–´ì£¼ì„¸ìš” â–¶ ê¿€ì´ ì—†ëŠ” ê²½ìš°, ì„¤íƒ• 1ìŠ¤í‘¼ìœ¼ë¡œ ëŒ€ì²´
                ê°€ëŠ¥í•©ë‹ˆë‹¤.
              </p>
              <div class="rounded-md p-4 stepContainer" id="stepContainer">
                <div class="step-wrapper flex items-center gap-4 mb-6">
                  <div class="stepNumText text-lime-500 font-semibold text-lg">Step1</div>
                  <textarea id="recipeStepDtos[0].content" name="recipeStepDtos[0].content"
                    class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none"
                    placeholder="{`step1`}"></textarea>
                  <input type="hidden" id="recipeStepDtos[0].stepNum" name="recipeStepDtos[0].stepNum" value="1" />
                  <!-- ì´ë¯¸ì§€ ì¶”ê°€ ì˜ì—­ -->
                  <div class="stepImg-wrapper">
                    <label for="file">
                      <div
                        class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md cursor-pointer">
                        <span class="material-symbols-outlined text-neutral-400">add</span>
                      </div>
                    </label>
                    <input type="file" id="file" accept="image/*" style="display: none;" data-step="0" />
                  </div>
                </div>
                <!-- step ì¶”ê°€ button -->
                <div class="flex justify-center">
                  <button id="addStepButton" name="addStepButton"
                    class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                    <span class="material-symbols-outlined">add</span>
                    Step ì¶”ê°€
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- {/* Divider */} -->
          <div class="border-t border-neutral-300 my-4"></div>

          <!-- ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ -->
          <div class="form-section">
            <div class="flex items-center gap-4 mb-6 mt-6">
              <h3 class="text-neutral-950 font-title mb-2">ìš”ë¦¬ ì™„ì„± ì‚¬ì§„</h3>
              <div class="finalImgContainer flex items-center gap-2">
                <div id="recipeFinalImg1" name="recipeFinalImg1" class="relative">
                  <div
                    class="recipeFinalImg1 w-[140px] h-[140px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                    <input type="file" name="recipeImageDtos[0].image" accept="image/*" style="display: none;" />
                    <div class="step-preview"></div>
                    <span class="material-symbols-outlined text-neutral-400">add</span>
                  </div>
                  <!-- <button
                      class="absolute top-0 right-0 bg-black text-white w-[24px] h-[24px] flex items-center justify-center rounded-full text-xs">
                      âœ•
                    </button> -->
                </div>

              </div>
              <!-- ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ ì¶”ê°€ button -->
              <div class="flex justify-center">
                <button id="addFinalImgButton" name="addFinalImgButton"
                  class="bg-lime-500 text-white w-[120px] py-2 rounded-md flex items-center justify-center text-sm gap-2">
                  <span class="material-symbols-outlined">add</span>
                  ì‚¬ì§„ ì¶”ê°€
                </button>
              </div>
            </div>
            <p class="text-sm text-neutral-500 mt-4 mb-4 flex items-center justify-center">
              ìµœì†Œ ì‚¬ì§„ 1ì¥ì€ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤. ì²«ë²ˆì§¸ë¡œ ë“±ë¡í•œ ì‚¬ì§„ì´ ëŒ€í‘œì‚¬ì§„ì´ ë©ë‹ˆë‹¤. (ìµœëŒ€ ë“±ë¡ ì‚¬ì§„ 4ì¥)
            </p>
            <p class="text-sm text-neutral-500 mt-4 mb-4 flex items-center justify-center">
              ì²«ë²ˆì§¸ë¡œ ë“±ë¡í•œ ì‚¬ì§„ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëŒ€ì‹ , ë‹¤ì‹œ ì˜ì—­ì„ ëˆŒëŸ¬ ë‹¤ë¥¸ ì‚¬ì§„ìœ¼ë¡œ êµì²´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
            <!-- button -->
            <div class="flex justify-center items-center gap-4">
              <button type="submit" class="bg-lime-500 text-white rounded-md py-2 px-6 text-sm">
                ì €ì¥ í›„ ê³µê°œí•˜ê¸°
              </button>
              <a th:href="@{list(page=${requestDto.page},size=${requestDto.size},type=${requestDto.type},keyword=${requestDto.keyword})}"
                class="border border-lime-500 text-lime-500 rounded-md py-2 px-6 text-sm">
                ì·¨ì†Œ
              </a>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<th:block layout:fragment="js">
  <script>
    const csrfValue = '[[${_csrf.token}]]';
  </script>

  <!-- TODO: ì¬ë£Œì •ë³´ row ì¶”ê°€ ë²„íŠ¼ -->
  <script>
    function addIngredient() {
      const index = document.querySelectorAll('.ingredient-input').length;
      const html = `
            <div class="ingredient-input">
                <input name="recipeIngredientDtos[${index}].name" />
                <input name="recipeIngredientDtos[${index}].quantity" />
            </div>`;
    }
    //<!-- ì¬ë£Œ ì¶”ê°€ ë²„íŠ¼ -->
    document.addEventListener('DOMContentLoaded', function () {
      const addIngredientBtn = document.getElementById("addIngredientBtn");
      if (addIngredientBtn) {
        addIngredientBtn.addEventListener("click", function () {
          try {
            const ingredientsContainer = document.getElementById("ingredientsContainer");
            const currentInputs = ingredientsContainer.getElementsByClassName("ingredient-input");
            const newIndex = currentInputs.length;

            if (newIndex >= 50) {
              alert("ìµœëŒ€ 50ê°œì˜ ì¬ë£Œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
              return;
            }

            const newIngredientDiv = document.createElement("div");
            newIngredientDiv.className = "ingredient-input";
            newIngredientDiv.innerHTML = `
                  <div class="grid grid-cols-4 gap-4 items-center">
                      <input id="recipeIngredientDtos[${newIndex}].name" 
                            name="recipeIngredientDtos[${newIndex}].name" 
                            type="text"
                            class="form-control border-neutral-300 border rounded-md px-3 py-2"
                            placeholder="ì¬ë£Œëª…" />
                      <input id="recipeIngredientDtos[${newIndex}].quantity" 
                            name="recipeIngredientDtos[${newIndex}].quantity" 
                            type="text"
                            class="form-control border-neutral-300 border rounded-md px-3 py-2"
                            placeholder="ìš©ëŸ‰ (ì˜ˆ: 10g)" />
                      <button type="button" class="btn btn-danger delete-row-btn bg-red-500 text-white px-3 py-2 rounded-md">X</button>
                  </div>
              `;

            ingredientsContainer.appendChild(newIngredientDiv);

            const deleteButton = newIngredientDiv.querySelector(".delete-row-btn");
            deleteButton.addEventListener("click", () => handleDeleteRow(newIngredientDiv));
          } catch (error) {
            console.error("ì¬ë£Œ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:", error);
          }
        });
      }
    });

    // ì¬ë£Œ ì¤„ ì‚­ì œ 
    function handleDeleteRow(rowElement) {
      const inputs = rowElement.querySelectorAll("input");
      const hasInputValue = Array.from(inputs).some(input => input.value.trim() !== "");

      if (hasInputValue) {
        const confirmDelete = confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì •ì¤‘ì— ì‚­ì œí•œ ì¤„ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        if (!confirmDelete) return;
      }

      // ì‚­ì œëœ í–‰ ì œê±°
      rowElement.remove();

      // ì¬ë£Œ ì •ë³´ ì¬ì •ë ¬
      reorderIngredients();
    }

    // ì¬ë£Œ ìˆœì„œ ì¬ì •ë ¬
    function reorderIngredients() {
      const ingredientsContainer = document.getElementById("ingredientsContainer");
      const rows = ingredientsContainer.querySelectorAll(".ingredient-input");

      rows.forEach((rowElement, index) => {
        // ì¸ë±ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ ì‹¤ì œ í‘œì‹œë  ë²ˆí˜¸ë¥¼ ìœ„í•´ +1
        const newIndex = index;

        // ì¬ë£Œëª… Input ID ë° Name ë³€ê²½
        const ingreNameInput = rowElement.querySelector('input[id^="recipeIngredientDtos"]');
        ingreNameInput.id = `recipeIngredientDtos[${newIndex}].name`;
        ingreNameInput.name = `recipeIngredientDtos[${newIndex}].name`;

        // ìš©ëŸ‰ Input ID ë° Name ë³€ê²½
        const ingreAmountInput = rowElement.querySelector('input[name$="quantity"]');
        ingreAmountInput.id = `recipeIngredientDtos[${newIndex}].quantity`;
        ingreAmountInput.name = `recipeIngredientDtos[${newIndex}].quantity`;
      });
    }

    // ê¸°ì¡´ ì…ë ¥ í•„ë“œì— ì¬ë£Œ ì¤„ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ (ì¬ë£Œ ì •ë³´ 2ì¤„ ì œì™¸)
    document.querySelectorAll("#ingredientsContainer .ingredient-input").forEach((rowElement, index) => {
      if (index >= 2) {
        const deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.className = "delete-row-btn bg-red-500 text-white px-3 py-2 rounded-md";
        deleteButton.textContent = "X";
        deleteButton.addEventListener("click", () => handleDeleteRow(rowElement));
        rowElement.querySelector(".grid").appendChild(deleteButton);
      }
    });
  </script>

  <!-- TODO: ì‚¬ì§„ ì—…ë¡œë“œ ê³µí†µ í•¨ìˆ˜ uploadImage -->
  <script>
    async function uploadImage(file, path) {
      console.log("ì—…ë¡œë“œ ", file);
      const formData = new FormData();
      formData.append('uploadFiles', file);

      try {
        const response = await fetch(`/recipe/upload/${path}`, {
          method: 'POST',
          headers: {
            'X-CSRF-TOKEN': csrfValue
          },
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('Upload error response:', errorText);
          throw new Error('Upload failed');
        }

        const result = await response.json();
        console.log(result);
        return result;
      } catch (error) {
        console.error('Image upload failed:', error);
        throw error;
      }
    }
  </script>

  <!-- TODO: Step ìš”ë¦¬ ìˆœì„œ ì˜ì—­ js -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const stepContainer = document.querySelector('.stepContainer');
      const addStepButton = document.getElementById('addStepButton');
      const maxSteps = 25;

      // ì´ˆê¸° Step ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”©
      bindInitialStepImageUpload();

      // Step ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      addStepButton.addEventListener('click', addNewStep);

      function bindInitialStepImageUpload() {
        try {

          // ì²«ë²ˆì§¸ ìŠ¤í… ì´ë²¤íŠ¸ ë™ì‘
          const initialFileInput = document.querySelector(".step-wrapper [type='file']");

          if (initialFileInput) {
            initialFileInput.addEventListener('change', (e) => handleStepImageUpload(e.target, 0));
          }

          // ì²« ë²ˆì§¸ Stepì˜ ì´ë¯¸ì§€ ì¶”ê°€ ì˜ì—­ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
          // const initialImageWrapper = document.querySelector(".step-wrapper .stepImg-wrapper");
          // if (initialImageWrapper) {
          //   initialImageWrapper.addEventListener('click', () => {
          //     initialFileInput.click();
          //   });
          // }
        } catch (error) {
          console.error('ì´ˆê¸° Step ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì¤‘ ì˜¤ë¥˜:', error);
        }
      }

      function addNewStep(event) {
        event.preventDefault();
        try {
          const stepCount = stepContainer.querySelectorAll('.step-wrapper').length;
          if (stepCount >= maxSteps) {
            alert(`ìµœëŒ€ ${maxSteps}ê°œì˜ Stepë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }

          const newStep = createStepElement(stepCount);
          const addButtonContainer = addStepButton.parentNode;
          stepContainer.insertBefore(newStep, addButtonContainer);

          bindStepEvents(newStep, stepCount);
          reorderSteps();
        } catch (error) {
          console.error('ìƒˆ Step ì¶”ê°€ ì¤‘ ì˜¤ë¥˜:', error);
          alert('Step ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      function createStepElement(stepCount) {
        const newStep = document.createElement('div');
        newStep.className = 'step-wrapper flex items-center gap-4 mb-6';
        newStep.innerHTML = `
            <div class="stepNumText text-lime-500 font-semibold text-lg">Step${stepCount + 1}</div>
            <textarea id="recipeStepDtos[${stepCount}].content" name="recipeStepDtos[${stepCount}].content" class="flex-1 h-[160px] border border-neutral-300 rounded-md p-2 text-sm overflow-auto resize-none" placeholder="Step ${stepCount + 1}"></textarea>
            <input type="hidden" id="recipeStepDtos[${stepCount}].stepNum" name="recipeStepDtos[${stepCount}].stepNum" value="${stepCount + 1}" />
            <div class="stepImg-wrapper">
                <label for="file${stepCount}">
                    <div class="w-[160px] h-[160px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md cursor-pointer">
                        <span class="material-symbols-outlined text-neutral-400">add</span>
                    </div>
                </label>
                <input type="file" name="recipeStepDtos[${stepCount}].stepImage" id="file${stepCount}" accept="image/*" style="display: none;" data-step="${stepCount}"/>
            </div>
            <button type="button" class="delete-step-btn btn btn-danger bg-red-500 text-white px-3 py-2 rounded-md">X</button>
        `;
        return newStep;
      }

      function bindStepEvents(stepElement, stepCount) {
        const fileInput = stepElement.querySelector("[type='file']");
        const deleteButton = stepElement.querySelector('.delete-step-btn');

        fileInput.addEventListener('change', (e) => handleStepImageUpload(e.target, stepCount));
        deleteButton.addEventListener('click', () => deleteStep(stepElement));
      }

      function deleteStep(stepElement) {
        try {
          const textArea = stepElement.querySelector('textarea');
          const hasInputValue = textArea && textArea.value.trim() !== '';
          if (hasInputValue) {
            const confirmDelete = confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ìˆ˜ì •ì¤‘ì— ì‚­ì œí•œ ì¤„ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            if (!confirmDelete) return;
          }
          stepElement.remove();
          reorderSteps();
        } catch (error) {
          console.error('Step ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
          alert('Step ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      function reorderSteps() {
        try {
          const stepElements = stepContainer.querySelectorAll('.step-wrapper');
          stepElements.forEach((stepElement, index) => {
            const newStepNumber = index + 1;
            stepElement.querySelector('.stepNumText').textContent = `Step${newStepNumber}`;

            const textArea = stepElement.querySelector('textarea');
            textArea.id = `recipeStepDtos[${index}].content`;
            textArea.name = `recipeStepDtos[${index}].content`;
            textArea.placeholder = `Step ${newStepNumber}`;

            const hiddenInput = stepElement.querySelector('input[type="hidden"]');
            hiddenInput.name = `recipeStepDtos[${index}].stepNum`;
            hiddenInput.value = newStepNumber;

            const fileInput = stepElement.querySelector('input[type="file"]');
            fileInput.name = `recipeStepDtos[${index}].stepImage`;
            fileInput.id = `file${index}`;
            fileInput.dataset.step = index;
          });
        } catch (error) {
          console.error('Step ì¬ì •ë ¬ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }



      function createImagePreview(file, uploadResult, idx) {

        const imgPreview = document.createElement('div');
        imgPreview.className = 'image-preview';
        const imgElement = document.createElement('img');
        imgElement.src = URL.createObjectURL(file);
        imgElement.className = 'w-[160px] h-[160px] object-cover rounded-md';
        imgPreview.appendChild(imgElement);

        const hiddenInputs = [
          { name: `recipeStepDtos[${idx}].uuid`, value: uploadResult.uuid },
          { name: `recipeStepDtos[${idx}].imgName`, value: uploadResult.fileName },
          { name: `recipeStepDtos[${idx}].path`, value: uploadResult.folderPath }
        ];

        const stepImages = document.createElement('div');
        stepImages.className = 'stepImages';

        hiddenInputs.forEach(input => {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = input.name;
          hiddenInput.value = input.value;
          stepImages.appendChild(hiddenInput);
        });

        imgPreview.appendChild(stepImages);

        console.log(imgPreview);

        return imgPreview;
      }

      async function handleStepImageUpload(fileInput, idx) {
        try {
          const file = fileInput.files[0];
          if (!file) return;

          const path = "step";
          const uploadResult = await uploadImage(file, path);

          const imgPreview = createImagePreview(file, uploadResult, idx);
          const stepImgWrapper = fileInput.closest('.stepImg-wrapper');
          stepImgWrapper.innerHTML = '';
          stepImgWrapper.appendChild(imgPreview);
        } catch (error) {
          console.error('Step ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }


    });
  </script>

  <!-- TODO: ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ js -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const maxImages = 4;
      const addButton = document.getElementById("addFinalImgButton");
      const container = document.querySelector(".finalImgContainer");

      initializeFinalImages();
      addButton.addEventListener("click", addFinalImage);

      function displayFinalImagePreview(imageDiv, file, uploadResult, index) {
        const imgElement = document.createElement('img');
        imgElement.src = URL.createObjectURL(file);
        imgElement.className = 'w-[140px] h-[140px] object-cover rounded-md';

        const hiddenInputs = [
          { name: `recipeImageDtos[${index}].uuid`, value: uploadResult.uuid },
          { name: `recipeImageDtos[${index}].imgName`, value: uploadResult.fileName },
          { name: `recipeImageDtos[${index}].path`, value: uploadResult.folderPath }
        ];

        imageDiv.innerHTML = '';
        imageDiv.appendChild(imgElement);

        hiddenInputs.forEach(input => {
          const hiddenInput = document.createElement('input');
          hiddenInput.type = 'hidden';
          hiddenInput.name = input.name;
          hiddenInput.value = input.value;
          imageDiv.appendChild(hiddenInput);
        });
      }

      function selectFile(accept) {
        return new Promise((resolve) => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = accept;
          input.style.display = 'none';
          input.onchange = () => {
            const file = input.files[0];
            document.body.removeChild(input);
            resolve(file);
          };
          document.body.appendChild(input);
          input.click();
        });
      }

      async function handleFinalImageUpload(imageDiv, index) {
        try {
          const file = await selectFile('image/*');
          if (!file) return;

          const path = "image";
          const uploadResult = await uploadImage(file, path);

          displayFinalImagePreview(imageDiv, file, uploadResult, index);
        } catch (error) {
          console.error('ì™„ì„± ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
          alert('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      function initializeFinalImages() {
        try {
          const initialImageDiv = document.querySelector("#recipeFinalImg1 > .recipeFinalImg1");
          if (initialImageDiv) {
            initialImageDiv.addEventListener("click", () => handleFinalImageUpload(initialImageDiv, 0));
          }
        } catch (error) {
          console.error("ì´ˆê¸° ì™„ì„± ì‚¬ì§„ ì´ë²¤íŠ¸ ë°”ì¸ë”© ì¤‘ ì˜¤ë¥˜:", error);
        }
      }

      function addFinalImage(event) {
        event.preventDefault();
        try {
          const currentImages = container.querySelectorAll(".relative").length;
          if (currentImages >= maxImages) {
            alert(`ì‚¬ì§„ì€ ìµœëŒ€ ${maxImages}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            return;
          }

          const newImageDiv = createFinalImageElement(currentImages);
          container.appendChild(newImageDiv);
          bindFinalImageEvents(newImageDiv, currentImages);
        } catch (error) {
          console.error("ì™„ì„± ì‚¬ì§„ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          alert("ì‚¬ì§„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        }
      }

      function createFinalImageElement(index) {
        const newDiv = document.createElement("div");
        newDiv.classList.add("relative");
        const newImageId = `recipeFinalImg${index + 1}`;
        newDiv.innerHTML = `
            <div id="${newImageId}" name="${newImageId}" class="w-[140px] h-[140px] border border-neutral-300 bg-neutral-100 flex items-center justify-center rounded-md">
                <span class="material-symbols-outlined text-neutral-400">add</span>
            </div>
            <button type="button" class="delete-final-img-btn absolute top-0 right-0 bg-black text-white w-[24px] h-[24px] flex items-center justify-center rounded-full text-xs">
                âœ•
            </button>
        `;
        return newDiv;
      }

      function bindFinalImageEvents(imageDiv, index) {
        const uploadArea = imageDiv.querySelector(`#recipeFinalImg${index + 1}`);
        const deleteButton = imageDiv.querySelector(".delete-final-img-btn");

        uploadArea.addEventListener("click", () => handleFinalImageUpload(uploadArea, index));
        deleteButton.addEventListener("click", () => handleDeleteFinalImage(imageDiv));
      }

      async function handleDeleteFinalImage(imageDiv) {
        try {
          const confirmDelete = confirm('ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
          if (!confirmDelete) return;

          const uuid = imageDiv.querySelector('input[name$="uuid"]')?.value;
          if (uuid) {
            await deleteImage(uuid);
          }

          imageDiv.remove();
          updateFinalImageIds();
        } catch (error) {
          console.error('ì™„ì„± ì‚¬ì§„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
          alert('ì´ë¯¸ì§€ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
      }

      async function deleteImage(uuid) {
        try {
          const response = await fetch('/upload/remove', {
            method: 'POST',
            headers: {
              'X-CSRF-TOKEN': csrfValue,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ uuid })
          });

          if (!response.ok) {
            throw new Error('ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨');
          }
        } catch (error) {
          console.error('ì´ë¯¸ì§€ ì‚­ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜:', error);
          throw error;
        }
      }

      function updateFinalImageIds() {
        try {
          const images = container.querySelectorAll(".relative");
          images.forEach((image, index) => {
            const newId = `recipeFinalImg${index + 1}`;
            const imageDiv = image.querySelector("div");
            imageDiv.id = newId;
            imageDiv.name = newId;

            const hiddenInputs = image.querySelectorAll('input[type="hidden"]');
            hiddenInputs.forEach(input => {
              input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
            });
          });
        } catch (error) {
          console.error("ì™„ì„± ì‚¬ì§„ ID ì¬ì •ë ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
      }
    });

  </script>

  <!-- TODO: createForm ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬ -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // const form = document.getElementById('createForm');
      // form.addEventListener('submit', handleFormSubmit);

      // async function handleFormSubmit(e) {
      //   e.preventDefault();

      //   console.log(form);

      // }


      //   console.log(form.innerHTML);
      // try {
      //   if (!validateForm()) return;

      //   const form = document.getElementById('createForm');
      //   const formData = new FormData(form);

      //   // ìŠ¤í… ì´ë¯¸ì§€ ì²˜ë¦¬
      //   const stepImages = document.querySelectorAll('.stepImg-wrapper .stepImages');
      //   stepImages.forEach((step, index) => {
      //     formData.append(`recipeStepDtos[${index}].uuid`, step.uuid);
      //     formData.append(`recipeStepDtos[${index}].imgName`, step.imgName);
      //     formData.append(`recipeStepDtos[${index}].path`, step.path);
      //   });

      //   // ì™„ì„± ì‚¬ì§„ ì²˜ë¦¬
      //   const finalImages = document.querySelectorAll('.finalImgContainer img');
      //   finalImages.forEach((img, index) => {
      //     const fileInput = img.closest('.relative').querySelector('input[type="file"]');
      //     if (fileInput.files[0]) {
      //       formData.append(`recipeImageDtos[${index}].image`, fileInput.files[0]);
      //     }
      //   });

      //   const response = await fetch('/recipe/create', {
      //     method: 'POST',
      //     headers: {
      //       'X-CSRF-TOKEN': csrfValue
      //     },
      //     body: formData
      //   });

      //   if (!response.ok) {
      //     const errorText = await response.text();
      //     throw new Error(errorText);
      //   }

      //   const rno = await response.json();
      //   alert('ë ˆì‹œí”¼ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      //   // window.location.href = `/recipe/read?rno=${rno}`;
      //   window.location.href = `/recipe/list`;
      // } catch (error) {
      //   console.error('ë ˆì‹œí”¼ ë“±ë¡ ì˜¤ë¥˜:', error);
      //   alert('ë ˆì‹œí”¼ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      // }
      // }

      function validateForm() {
        if (!validateRequiredFields()) return false;
        if (!validateIngredients()) return false;
        if (!validateSteps()) return false;
        if (!validateImages()) return false;
        return true;
      }

      function validateRequiredFields() {
        const requiredFields = {
          'title': 'ë ˆì‹œí”¼ ì œëª©',
          'content': 'ìš”ë¦¬ ì†Œê°œ',
          'category': 'ì¹´í…Œê³ ë¦¬',
          'serving': 'ì¸ì›',
          'time': 'ì‹œê°„',
          'difficulty': 'ë‚œì´ë„'
        };

        for (const [fieldId, fieldName] of Object.entries(requiredFields)) {
          const field = document.getElementById(fieldId);
          if (!field || !field.value.trim()) {
            alert(`${fieldName}ì„(ë¥¼) ì…ë ¥í•´ì£¼ì„¸ìš”.`);
            field?.focus();
            return false;
          }
        }
        return true;
      }

      function validateIngredients() {
        const ingredients = document.querySelectorAll('.ingredient-input');
        if (ingredients.length < 2) {
          alert('ìµœì†Œ 2ê°œì˜ ì¬ë£Œê°€ í•„ìš”í•©ë‹ˆë‹¤.');
          return false;
        }

        let validIngredients = 0;
        ingredients.forEach(ingredient => {
          const nameInput = ingredient.querySelector('input[name$=".name"]');
          const quantityInput = ingredient.querySelector('input[name$=".quantity"]');
          if (nameInput.value.trim() && quantityInput.value.trim()) {
            validIngredients++;
          }
        });

        if (validIngredients < 2) {
          alert('ìµœì†Œ 2ê°œì˜ ì¬ë£Œì— ëŒ€í•´ ì´ë¦„ê³¼ ì–‘ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return false;
        }
        return true;
      }

      function validateSteps() {
        const steps = document.querySelectorAll('.step-wrapper');
        if (steps.length < 3) {
          alert('ìš”ë¦¬ ìˆœì„œëŠ” ìµœì†Œ 3ê°œ ì´ìƒ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.');
          return false;
        }

        let validSteps = 0;
        steps.forEach(step => {
          const content = step.querySelector('textarea').value.trim();
          if (content) {
            validSteps++;
          }
        });

        if (validSteps < 3) {
          alert('ìš”ë¦¬ ìˆœì„œëŠ” ìµœì†Œ 3ê°œ ì´ìƒì˜ ë‚´ìš©ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
          return false;
        }
        return true;
      }

      function validateImages() {
        const finalImages = document.querySelectorAll('.finalImgContainer img');
        if (finalImages.length === 0) {
          alert('ìµœì†Œ 1ì¥ì˜ ìš”ë¦¬ ì™„ì„± ì‚¬ì§„ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          return false;
        }
        return true;
      }
    });

  </script>

</th:block>

</html>