<!DOCTYPE html>
<html lang="zxx" layout:decorate="~{/layouts/board/detailLayout}">
  <head>
    <meta charset="UTF-8" />
    <title>Board Content</title>
    <link rel="stylesheet" th:href="@{/css/board/detail.css}" />
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  </head>

  <body>
    <div layout:fragment="content">
      <div class="container">
        <div class="container">
          <div class="row align-center">
            <div class="custom-col m-15px-tb">
              <article class="blog-article">
                <div class="blog-article-header">
                  <h4>
                    <a
                      th:href="@{/board/list(category=${board.categoryId})}"
                      th:text="${board.categoryId == 1 ? 'Free' : (board.categoryId == 2 ? 'Q&A' : (board.categoryId == 3 ? 'TIP' : 'Unknown'))}"
                    >
                      Category
                    </a>
                  </h4>
                  <h2 th:text="${board.title}">Ï†úÎ™©</h2>

                  <!-- Ï°∞Ìöå Ïàò Î∞è ÎåìÍ∏Ä Ïàò Ï∂îÍ∞Ä -->
                  <div class="meta-info">
                    <span
                      ><i class="fa-solid fa-eye"></i> Ï°∞ÌöåÏàò:
                      <span th:text="${board.viewCount}"></span
                    ></span>
                    <span
                      ><i class="fa-solid fa-comment"></i> ÎåìÍ∏Ä:
                      <span th:text="${commentCount}"></span
                    ></span>
                  </div>

                  <div class="media">
                    <div class="avatar">
                      <!-- üî• Í≤åÏãúÍ∏Ä ÏûëÏÑ±ÏûêÏùò ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÌëúÏãú -->
                      <img
                        th:src="${board.profileImage}"
                        alt="ÏûëÏÑ±Ïûê ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"
                      />
                    </div>
                    <div class="media-body">
                      <label th:text="${board.userid}">Nickname</label>
                      <span
                        th:text="${#temporals.format(board.regDate, 'yyyyÎÖÑ MMÏõî ddÏùº HHÏãú mmÎ∂Ñ')}"
                        >ÏûëÏÑ± ÏãúÍ∞Ñ</span
                      >
                    </div>
                    <div class="post-buttons">
                      <a
                        th:if="${board.userid == #authentication.name}"
                        th:href="@{/board/modify/{bno}(bno=${board.bno})}"
                        class="btn btn-secondary modify-btn"
                      >
                        Modify
                      </a>
                      <form
                        th:if="${board.userid == #authentication.name}"
                        th:action="@{/board/delete/{bno}(bno=${board.bno})}"
                        method="post"
                        style="display: inline"
                      >
                        <input
                          type="hidden"
                          name="_csrf"
                          th:value="${_csrf.token}"
                        />
                        <button type="submit" class="btn btn-danger delete-btn">
                          Delete
                        </button>
                      </form>
                    </div>
                  </div>
                </div>

                <div th:if="${board.imageFileName}" class="article-img">
                  <img
                    th:src="@{/upload/{filename}(filename=${board.imageFileName})}"
                    alt="Ï≤®Î∂Ä Ïù¥ÎØ∏ÏßÄ"
                    style="max-width: 100%; height: auto"
                  />
                </div>

                <div class="blog-article-body">
                  <p th:utext="${board.content}" class="content-text"></p>
                </div>
              </article>

              <!-- ÎåìÍ∏Ä ÏûëÏÑ± Ìèº -->
              <div class="blog-comment-form">
                <textarea
                  id="comment"
                  name="content"
                  rows="4"
                  class="form-control"
                  placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."
                ></textarea>
                <input type="hidden" id="boardId" th:value="${board.bno}" />
                <button
                  type="button"
                  class="btn btn-primary"
                  id="submitComment"
                >
                  Submit
                </button>
              </div>

              <!-- ÎåìÍ∏Ä Î™©Î°ù -->
              <article class="blog-reply-content">
                <div class="container bootstrap snippets bootdey">
                  <div class="row">
                    <div class="col-md-12">
                      <div class="blog-comment">
                        <ul class="comments">
                          <li th:each="comment : ${comments}" class="clearfix">
                            <!-- üî• ÎåìÍ∏Ä ÏûëÏÑ±ÏûêÏùò ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ ÌëúÏãú -->
                            <img
                              th:src="${comment.profileImage}"
                              class="avatar"
                              alt="ÎåìÍ∏Ä ÏûëÏÑ±Ïûê ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"
                            />
                            <div
                              class="post-comments"
                              data-comment-id="${comment.id}"
                            >
                              <p class="meta">
                                <span th:text="${comment.userid}">ÏûëÏÑ±Ïûê</span>
                                <span
                                  th:text="${#temporals.format(comment.regDate, 'yyyy-MM-dd HH:mm')}"
                                  >ÏûëÏÑ± ÏãúÍ∞Ñ</span
                                >
                                <i class="pull-right">
                                  <a
                                    th:if="${comment.userid == #authentication.name}"
                                    href="#"
                                    class="delete-link"
                                    th:data-comment-id="${comment.id}"
                                  >
                                    <small>Delete</small>
                                  </a>
                                </i>
                              </p>
                              <p th:text="${comment.content}">ÎåìÍ∏Ä ÎÇ¥Ïö©</p>
                            </div>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>

      <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
      <script>
        // ÎåìÍ∏Ä ÏûëÏÑ± AJAX
        $("#submitComment").click(function () {
          const commentContent = $("#comment").val();
          const boardId = $("#boardId").val();

          if (!commentContent.trim()) {
            alert("ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
            return;
          }

          console.log("Submitting comment:", { commentContent, boardId });

          const csrfToken = $("meta[name='_csrf']").attr("content");
          const csrfHeader = $("meta[name='_csrf_header']").attr("content");

          fetch("/board/comment", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              [csrfHeader]: csrfToken,
            },
            body: JSON.stringify({ content: commentContent, boardId: boardId }),
          })
            .then((response) => {
              if (response.ok) {
                alert("ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
                location.reload(); // ÌéòÏù¥ÏßÄ ÏÉàÎ°úÍ≥†Ïπ®
              } else {
                response.json().then((err) => {
                  console.error("Error response from server:", err);
                  alert("ÎåìÍ∏Ä Îì±Î°ù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                });
              }
            })
            .catch((error) => {
              console.error("Error during submission:", error);
              alert("ÎåìÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
            });
        });

        // ÎåìÍ∏Ä ÏÇ≠Ï†ú AJAX
        $(".delete-link").click(function (event) {
          event.preventDefault();
          const commentId = $(this).attr("data-comment-id");

          if (confirm("Ïù¥ ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
            const csrfToken = $("meta[name='_csrf']").attr("content");
            const csrfHeader = $("meta[name='_csrf_header']").attr("content");

            fetch(`/board/comment/${commentId}`, {
              method: "DELETE",
              headers: { [csrfHeader]: csrfToken },
            })
              .then((response) => {
                if (response.ok) {
                  alert("ÎåìÍ∏ÄÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                  $(this).closest(".post-comments").parent().remove();
                } else {
                  alert("ÎåìÍ∏Ä ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
              })
              .catch((error) => {
                console.error("Error during deletion:", error);
                alert("ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
              });
          }
        });
      </script>
    </div>
  </body>
</html>
